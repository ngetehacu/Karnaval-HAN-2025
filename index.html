<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lomba Hari Anak Nasional 2025 - Kab. Tabalong</title>
    <link rel="icon" href="https://disdik.tabalongkab.go.id/wp-content/uploads/2022/12/logo-tabalong-1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .font-fredoka { font-family: 'Fredoka One', cursive; }
        .transition-all { transition: all 0.3s ease-in-out; }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes pulse-bg {
            0%, 100% { background-color: #fef3c7; }
            50% { background-color: #fee2e2; }
        }
        .pulse-bg-animation { animation: pulse-bg 2s infinite; }
        @keyframes floaty-background {
            0% { background-position: 0 0; }
            100% { background-position: 560px 560px; }
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* sky-50 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='100' y1='33' x2='100' y2='-3'%3E%3Cstop offset='0' stop-color='%23000' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%23000' stop-opacity='1'/%3E%3C/linearGradient%3E%3ClinearGradient id='b' gradientUnits='userSpaceOnUse' x1='100' y1='135' x2='100' y2='97'%3E%3Cstop offset='0' stop-color='%23000' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%23000' stop-opacity='1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg fill='%23f8b195' fill-opacity='0.1'%3E%3Crect x='100' width='100' height='100'/%3E%3Crect y='100' width='100' height='100'/%3E%3C/g%3E%3Cg fill-opacity='0.1'%3E%3Cpolygon fill='%23f67280' points='100 100 0 100 0 0 100 0 100 100'/%3E%3Cpolygon fill='%23c06c84' points='100 100 100 200 200 200 200 100 100 100'/%3E%3C/g%3E%3C/svg%3E"),
                              url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill-opacity='0.1' fill='%236c5b7b'%3E%3Ccircle cx='34' cy='15' r='6'/%3E%3Cpath d='M180 40 a10 10 0 0 1 0 20 a10 10 0 0 1 0 -20'/%3E%3Cpath d='M10 180 a12 12 0 0 1 0 24 a12 12 0 0 1 0 -24'/%3E%3Ccircle cx='150' cy='160' r='8'/%3E%3Cpath d='M50 80 l10 10 l-10 10 l-10 -10z'/%3E%3C/g%3E%3C/svg%3E");
            animation: floaty-background 80s linear infinite;
        }
        #dropdownMenu::-webkit-scrollbar { width: 8px; }
        #dropdownMenu::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #dropdownMenu::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        #dropdownMenu::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; flex-direction: column; gap: 1rem;
            backdrop-filter: blur(4px);
        }
        .timer-box {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            margin: 0 0.25rem;
            background-color: rgba(255,255,255,0.5);
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
            text-align: center;
        }
        .timer-box span {
            display: block;
            font-weight: bold;
        }
        .timer-box span:first-child {
            font-size: 1.75rem;
            line-height: 1;
        }
        .timer-box span:last-child {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #4b5563; /* gray-600 */
        }
        /* Custom Alert Animation */
        @keyframes alert-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes alert-zoom-in {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
        
        /* -- ANIMASI BARU -- */
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }
        #confetti-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            top: -20px;
            width: 10px;
            height: 20px;
            opacity: 0;
            animation: confetti-fall 4s linear forwards;
        }
        .sparkle-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }
        @keyframes sparkle-anim {
            0% { transform: scale(0); opacity: 0.5; }
            50% { opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: sparkle-anim 0.8s ease-out forwards;
            box-shadow: 0 0 10px 2px #fff;
        }
        
        /* STYLE UNTUK CETAK */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            @page {
                size: A4 portrait;
                margin: 0;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loadingOverlay">
        <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg font-semibold text-gray-700">Memuat data dari server...</p>
    </div>

    <!-- MODAL NOTIFIKASI BARU -->
    <div id="customAlertModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-[10000] flex items-center justify-center p-4" style="animation: alert-fade-in 0.3s ease;">
        <div class="relative mx-auto p-6 border w-full max-w-sm shadow-xl rounded-2xl bg-white" style="animation: alert-zoom-in 0.3s ease;">
            <div class="mt-3 text-center">
                <div id="customAlertIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <!-- Icon will be injected here -->
                </div>
                <h3 id="customAlertTitle" class="text-lg leading-6 font-bold text-gray-900"></h3>
                <div class="mt-2 px-2 py-3">
                    <p id="customAlertMessage" class="text-sm text-gray-500"></p>
                </div>
                <div id="customAlertButtons" class="items-center px-4 py-3 gap-2 flex">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PASSWORD EXPORT -->
    <div id="exportPasswordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900">Akses Terbatas !!!</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Masukkan kata sandi untuk melanjutkan proses export.
                    </p>
                    <form id="exportPasswordForm" autocomplete="off">
                        <input type="password" id="exportPasswordInput" autocomplete="new-password" placeholder="******" class="w-full px-4 py-3 mt-3 text-center bg-gray-100 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-lg">
                        <p id="exportPasswordError" class="text-red-500 text-sm mt-2 hidden">Kata sandi salah.</p>
                    </form>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex">
                    <button id="cancelExport" type="button" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:bg-gray-300 transition-all">
                        Batal
                    </button>
                    <button id="submitExport" type="button" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-all">
                        Export
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL ADMIN -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900">Login Admin</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Masukkan kata sandi admin untuk mengakses fitur khusus.
                    </p>
                    <form id="adminLoginForm" autocomplete="off">
                        <input type="password" id="adminPasswordInput" autocomplete="new-password" placeholder="******" class="w-full px-4 py-3 mt-3 text-center bg-gray-100 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-lg">
                        <p id="adminLoginError" class="text-red-500 text-sm mt-2 hidden">Kata sandi salah.</p>
                    </form>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex">
                    <button id="cancelAdminLogin" type="button" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:bg-gray-300 transition-all">
                        Batal
                    </button>
                    <button id="submitAdminLogin" type="button" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all">
                        Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL INFORMASI & BANTUAN -->
    <div id="infoModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-2xl bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="text-xl leading-6 font-bold text-gray-900 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Pusat Informasi & Bantuan
                    </h3>
                    <button id="closeInfoModalBtn" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div>
                        <h4 class="font-bold text-gray-800 mb-1">Jadwal Penting</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>Pendaftaran Dibuka:</strong> 08 September 2025, Pukul 08:00 WITA</li>
                            <li><strong>Pendaftaran Ditutup:</strong> 09 September 2025, Pukul 17:00 WITA</li>
                            <li><strong>Pelaksanaan Karnaval:</strong> Kamis, 11 September 2025</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800 mb-1">Kontak Panitia (Jika ada kendala)</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Bapak Dhiya (Bidang Teknis): <a href="https://wa.me/6285845923033" target="_blank" class="text-blue-600 hover:underline">0858-4592-3033</a></li>
                            <li>Ibu Nia (Bidang Acara): <a href="https://wa.me/628115198824" target="_blank" class="text-blue-600 hover:underline">0811-5198-824</a></li>
                        </ul>
                    </div>
                     <div>
                        <h4 class="font-bold text-gray-800 mb-1">Pertanyaan Umum (FAQ)</h4>
                        <div class="space-y-2">
                            <p><strong>T: Bagaimana jika saya lupa Kode Akses?</strong><br>J: Silakan hubungi kontak panitia di atas untuk meminta reset atau pengingat kode akses.</p>
                            <p><strong>T: Apakah nomor urut bisa dipilih?</strong><br>J: Tidak. Nomor urut diacak oleh sistem secara adil untuk semua peserta.</p>
                             <p><strong>T: Apa yang harus dibawa saat acara?</strong><br>J: Harap membawa bukti pendaftaran yang sudah di-download atau dicetak dari aplikasi ini.</p>
                        </div>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="okInfoModalBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full sm:w-auto shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- KONTEN UTAMA -->
    <div class="w-full max-w-md mx-auto bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl p-6 sm:p-8 border-4 border-white">

        <!-- BAGIAN LOGIN PENGGUNA BARU -->
        <div id="loginSection" class="hidden">
             <div class="flex justify-center items-center gap-4 mb-6">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQq9BqgIl6ON8ljjfpIV1tbRhV2cA_K_iYzcg&s" class="h-16" alt="Logo Tut Wuri Handayani" onerror="this.src='https://placehold.co/100x100/EEE/31343C?text=Logo'">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Lambang_Kabupaten_Tabalong.jpeg/500px-Lambang_Kabupaten_Tabalong.jpeg" alt="Logo Tabalong" class="h-20" onerror="this.src='https://placehold.co/100x100/EEE/31343C?text=Logo'">
                <img src="https://awsimages.detik.net.id/community/media/visual/2025/07/09/logo-hari-anak-nasional-2025-1752054507039.png?w=800" alt="Logo HAN" class="h-16" onerror="this.src='https://placehold.co/100x100/EEE/31343C?text=Logo'">
            </div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-fredoka text-blue-600">Selamat Datang!</h1>
                <p class="text-gray-600 mt-2 font-semibold">Silakan login untuk mengambil Nomor Urut Peserta Karnaval HAN 2025</p>
            </div>

            <div id="timeRestrictionMessage" class="text-center font-semibold p-4 rounded-lg my-4 hidden"></div>
            
            <div id="trialButtonsContainer" class="hidden space-y-2"></div>

            <form id="userLoginForm" class="space-y-4 hidden">
                <div>
                    <label for="npsnLoginInput" class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                    <input type="text" id="npsnLoginInput" placeholder="Masukkan NPSN Anda" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                </div>
                 <div>
                    <label for="kodeAksesLoginInput" class="block text-sm font-medium text-gray-700 mb-2">Kode Akses</label>
                    <input type="password" id="kodeAksesLoginInput" placeholder="Masukkan Kode Akses" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                </div>
                <p id="loginError" class="text-red-500 text-sm hidden">NPSN atau Kode Akses salah. Coba lagi.</p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:shadow-lg hover:scale-105 transform transition-all shadow-md text-lg">
                    Login
                </button>
            </form>

            <button type="button" id="showInfoBtn" class="w-full mt-4 bg-blue-50 text-blue-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-blue-100 transform transition-all border-2 border-blue-200 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                Informasi & Bantuan
            </button>

             <div class="text-center mt-4 border-t-2 border-gray-100 pt-4">
                <p class="text-sm font-semibold text-gray-600">Dinas Pendidikan & Kebudayaan</p>
                <p class="text-sm font-medium text-gray-500">Bidang PAUD & DIKMAS</p>
                <p class="text-xs text-gray-400 mt-2">Author: Dhiya</p>
                <button id="adminLoginBtn" class="text-xs text-gray-400 hover:text-blue-600 transition-all mt-2">[ Login Admin ]</button>
            </div>
        </div>


        <!-- BAGIAN APLIKASI UTAMA (SEBELUM MENGAMBIL NOMOR) -->
        <div id="mainAppSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                 <div class="flex items-center gap-2">
                     <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Lambang_Kabupaten_Tabalong.jpeg/500px-Lambang_Kabupaten_Tabalong.jpeg" alt="Logo Tabalong" class="h-12" onerror="this.src='https://placehold.co/100x100/EEE/31343C?text=Logo'">
                     <div>
                        <h1 class="text-xl font-fredoka text-blue-600">Nomor Urut Karnaval</h1>
                        <p class="text-gray-600 text-sm font-semibold">Hari Anak Nasional 2025</p>
                     </div>
                 </div>
                 <button id="logoutBtn" class="text-sm bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 transition-all">Logout</button>
            </div>
            
            <div id="adminModeBanner" class="hidden text-center font-bold p-3 rounded-lg my-4 bg-blue-100 text-blue-800 border border-blue-300">
                üëë ANDA LOGIN SEBAGAI ADMIN üëë
            </div>
            <div id="trialModeBanner" class="hidden text-center font-bold p-3 rounded-lg my-4 bg-purple-100 text-purple-800 border border-purple-300">
                ‚ö†Ô∏è ANDA DALAM MODE UJI COBA ‚ö†Ô∏è
            </div>

            <div id="sisaWaktuContainer" class="text-center p-3 rounded-lg my-4 hidden"></div>

            <form id="dataForm" class="space-y-4">
                <!-- HANYA TAMPIL UNTUK ADMIN -->
                <div class="relative hidden" id="searchContainer">
                    <label for="searchLembaga" class="block text-sm font-medium text-gray-700 mb-2">Cari PAUD / TK (Admin)</label>
                    <input type="text" id="searchLembaga" placeholder="Ketik untuk mencari..." class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <div id="dropdownMenu" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto p-1">
                    </div>
                </div>

                <!-- TAMPIL UNTUK PENGGUNA BIASA & ADMIN -->
                <div id="detailSekolah" class="space-y-3 text-sm bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div id="welcomeMessage" class="text-center text-lg font-bold text-blue-800 mb-4 p-3 bg-blue-100 rounded-lg"></div>
                    <div class="grid grid-cols-3 gap-x-2">
                        <strong class="col-span-1">NPSN</strong><span id="detailNpsn" class="col-span-2 text-gray-700"></span>
                        <strong class="col-span-1">Status</strong><span id="detailStatus" class="col-span-2 text-gray-700"></span>
                        <strong class="col-span-1">Kecamatan</strong><span id="detailKecamatan" class="col-span-2 text-gray-700"></span>
                        <strong class="col-span-1">Jumlah Peserta</strong><span id="detailJumlah" class="col-span-2 text-gray-700"></span>
                    </div>
                    <div class="border-t border-blue-200 pt-2 mt-2">
                        <strong class="block mb-1">Guru Perwakilan:</strong>
                        <div id="detailGuru" class="text-gray-700 space-y-1"></div>
                    </div>
                </div>
                
                <!-- INFO JIKA LEMBAGA SUDAH TERDAFTAR (UNTUK ADMIN) -->
                <div id="adminSudahTerdaftarInfo" class="hidden text-center bg-green-100 border-2 border-green-200 rounded-2xl p-6 my-4">
                    <p class="text-gray-800 mb-4 text-lg font-semibold">Lembaga ini sudah terdaftar dengan nomor urut:</p>
                    <div id="adminInfoNomorUrut" class="text-8xl font-fredoka text-green-600 my-2"></div>
                </div>

                 <div id="error-message" class="text-red-500 text-sm hidden">Mohon pilih lembaga dari daftar (Admin).</div>
                <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-yellow-500 text-white font-bold py-3 px-4 rounded-xl hover:shadow-lg hover:scale-105 transform transition-all shadow-md text-lg">
                    Ambil Nomor
                </button>
                <button type="button" id="viewDaftarBtn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-gray-50 transform transition-all border-2 border-gray-200 shadow-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                    Lihat Daftar
                </button>
            </form>
             <div class="text-center mt-6 border-t-2 border-gray-100 pt-3">
                <p class="text-sm font-semibold text-gray-600">Dinas Pendidikan & Kebudayaan</p>
                <p class="text-sm font-medium text-gray-500">Bidang PAUD & DIKMAS</p>
                <p class="text-xs text-gray-400 mt-2">Author: Dhiya</p>
            </div>
        </div>

        <!-- BAGIAN STATUS SUDAH TERDAFTAR (HALAMAN UTAMA SETELAH MENDAPAT NOMOR) -->
        <div id="registeredStatusSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                 <div class="flex items-center gap-2">
                     <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Lambang_Kabupaten_Tabalong.jpeg/500px-Lambang_Kabupaten_Tabalong.jpeg" alt="Logo Tabalong" class="h-12" onerror="this.src='https://placehold.co/100x100/EEE/31343C?text=Logo'">
                     <div>
                        <h1 class="text-xl font-fredoka text-blue-600">Status Pendaftaran</h1>
                        <p class="text-gray-600 text-sm font-semibold">Hari Anak Nasional 2025</p>
                     </div>
                 </div>
                 <button id="logoutFromStatusBtn" class="text-sm bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 transition-all">Logout</button>
            </div>
            
            <div class="text-center bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 relative">
                 <div class="sparkle-container"></div>
                <p class="text-gray-600 mb-2 text-lg">Anda sudah terdaftar dengan nomor urut:</p>
                <div id="statusNomorUrut" class="text-8xl font-fredoka text-blue-600 my-2"></div>
                <div id="statusNamaLembaga" class="text-2xl font-bold text-gray-800 mt-4 mb-4 p-3 bg-blue-100 rounded-lg"></div>

                <div class="mt-4 border-t border-blue-200 pt-4 text-left text-sm text-gray-700 space-y-2">
                    <div class="grid grid-cols-3 gap-x-2">
                        <strong class="col-span-1">NPSN</strong><span id="statusNpsn" class="col-span-2"></span>
                        <strong class="col-span-1">Status</strong><span id="statusStatus" class="col-span-2"></span>
                        <strong class="col-span-1">Kecamatan</strong><span id="statusKecamatan" class="col-span-2"></span>
                        <strong class="col-span-1">Jumlah Peserta</strong><span id="statusJumlah" class="col-span-2"></span>
                    </div>
                    <div class="border-t border-blue-200 pt-2 mt-2">
                        <strong class="block mb-1">Guru Perwakilan:</strong>
                        <div id="statusGuru" class="space-y-1"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <button type="button" id="downloadBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:shadow-lg transform transition-all shadow-md flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Download PDF
                </button>
                 <button type="button" id="printBtn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-xl hover:shadow-lg transform transition-all shadow-md flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd" /></svg>
                    Cetak Bukti
                </button>
            </div>
             <button type="button" id="viewDaftarFromStatusBtn" class="w-full mt-4 bg-white text-gray-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-gray-50 transform transition-all border-2 border-gray-200 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                Lihat Daftar
            </button>
             <div class="text-center mt-6 border-t-2 border-gray-100 pt-3">
                <p class="text-sm font-semibold text-gray-600">Dinas Pendidikan & Kebudayaan</p>
                <p class="text-sm font-medium text-gray-500">Bidang PAUD & DIKMAS</p>
                <p class="text-xs text-gray-400 mt-2">Author: Dhiya</p>
            </div>
        </div>

        <div id="spinnerSection" class="hidden text-center">
             <div class="sparkle-container"></div>
            <div class="bg-gradient-to-r from-purple-50 to-indigo-100 p-4 rounded-xl mb-6 border border-purple-200">
                <div class="flex items-center justify-center gap-2">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQq9BqgIl6ON8ljjfpIV1tbRhV2cA_K_iYzcg&s" class="h-8 w-8" alt="Logo Tut Wuri Handayani">
                    <h2 id="displayNamaLembaga" class="text-xl text-indigo-700 font-bold"></h2>
                </div>
            </div>
            <p class="text-gray-600 mb-4 font-fredoka text-2xl">Ayo kita ambil nomor!</p>
            <div id="spinnerDisplay" class="text-8xl font-fredoka text-gray-800 my-8 bg-gray-100 p-6 rounded-2xl pulse-bg-animation">000</div>
            <div class="space-y-3">
                <button id="spinBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold py-3 px-4 rounded-xl hover:shadow-lg hover:scale-105 transform transition-all shadow-md text-lg">
                    Ambil Nomor!
                </button>
                <button id="cancelBtn" class="w-full bg-transparent text-gray-600 font-semibold py-2 px-4 rounded-xl hover:bg-gray-100 transition-all text-sm">
                    Batalkan & Kembali
                </button>
            </div>
            <div id="nomorHabisMessage" class="hidden mt-4 text-red-500 font-semibold">
                Maaf, semua nomor urut sudah terambil.
            </div>
        </div>

        <div id="resultSection" class="hidden text-center relative">
            <div id="confetti-container"></div>
            <h2 class="text-5xl font-fredoka text-yellow-500 mb-3">Hore!</h2>
            <p class="text-gray-600 mb-6">Kamu mendapatkan nomor urut:</p>
            <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
                <div id="nomorUrut" class="text-8xl font-fredoka text-blue-600 my-2 pop-in"></div>
                <div class="mt-4 border-t border-blue-200 pt-4 text-left text-sm text-gray-700 space-y-2">
                    <p><strong>Nama Lembaga:</strong> <span id="resultNamaLembaga"></span></p>
                </div>
            </div>
            <div class="mt-6">
                <button id="kembaliKeUtamaBtn" class="w-full bg-blue-100 text-blue-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-blue-200 transform transition-all border-2 border-blue-200 shadow-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd"></path></svg>
                    Kembali ke Halaman Utama
                </button>
            </div>
            <div class="mt-8 text-left">
                <h3 class="text-lg font-bold text-gray-800 mb-3">Peserta Terdaftar</h3>
                <div class="overflow-x-auto bg-white rounded-lg border max-h-60 overflow-y-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold text-gray-600">No.</th>
                                <th class="p-3 font-semibold text-gray-600 text-left">Nama Lembaga</th>
                                <th class="p-3 font-semibold text-gray-600 text-left">Kecamatan</th>
                            </tr>
                        </thead>
                        <tbody id="daftarBodyResult" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="viewDaftarSection" class="hidden">
            <div class="text-center mb-6">
                <h1 id="viewDaftarTitle" class="text-3xl font-fredoka text-blue-600"></h1>
                <p id="viewDaftarSubtitle" class="text-gray-600 mt-2"></p>
            </div>
            <div class="overflow-x-auto bg-white rounded-lg border max-h-96">
                <table class="min-w-full text-sm table-auto">
                    <thead id="viewDaftarThead" class="bg-gray-50 sticky top-0">
                        </thead>
                    <tbody id="daftarBodyView" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="viewDaftarActions" class="grid grid-cols-2 gap-4 mt-6">
                <button id="kembaliBtn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-gray-50 transform transition-all border-2 border-gray-200 shadow-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                    Kembali
                </button>
                <button id="exportBtnView" class="export-btn w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-xl hover:shadow-lg transform transition-all shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================================
        // KONFIGURASI APLIKASI
        // ===============================================================
        const TANGGAL_MULAI = '2025-09-08T08:00:00';
        const TANGGAL_SELESAI = '2025-09-09T17:00:00'; 
        const SPIN_DURATION = 1500;
        const SPIN_INTERVAL = 50;
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 menit

        // --- URL Google Apps Script Web App ---
        // DIUBAH: Menggunakan URL baru yang Anda berikan
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwyz5_z6_nHOu-2gbXBxSToR2G2LKYxLp082EJRDybhRR_PWaJHQ8TkFgnZa231popN1w/exec';

        // ===============================================================
        // MENGAMBIL ELEMEN DARI DOM
        // ===============================================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertButtons = document.getElementById('customAlertButtons');
        const customAlertIcon = document.getElementById('customAlertIcon');
        
        // Sections
        const loginSection = document.getElementById('loginSection');
        const mainAppSection = document.getElementById('mainAppSection');
        const registeredStatusSection = document.getElementById('registeredStatusSection');
        const spinnerSection = document.getElementById('spinnerSection');
        const resultSection = document.getElementById('resultSection');
        const viewDaftarSection = document.getElementById('viewDaftarSection');
        
        // Login elements
        const userLoginForm = document.getElementById('userLoginForm');
        const npsnLoginInput = document.getElementById('npsnLoginInput');
        const kodeAksesLoginInput = document.getElementById('kodeAksesLoginInput');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');

        // Main App elements
        const adminModeBanner = document.getElementById('adminModeBanner');
        const trialModeBanner = document.getElementById('trialModeBanner');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const dataForm = document.getElementById('dataForm');
        const errorMessage = document.getElementById('error-message');
        const displayNamaLembaga = document.getElementById('displayNamaLembaga');
        const spinnerDisplay = document.getElementById('spinnerDisplay');
        const spinBtn = document.getElementById('spinBtn');
        const nomorHabisMessage = document.getElementById('nomorHabisMessage');
        const nomorUrutDisplay = document.getElementById('nomorUrut');
        const resultNamaLembaga = document.getElementById('resultNamaLembaga');
        const kembaliKeUtamaBtn = document.getElementById('kembaliKeUtamaBtn');
        const viewDaftarBtn = document.getElementById('viewDaftarBtn');
        const kembaliBtn = document.getElementById('kembaliBtn');
        const daftarBodyResult = document.getElementById('daftarBodyResult');
        const daftarBodyView = document.getElementById('daftarBodyView');
        const viewDaftarTitle = document.getElementById('viewDaftarTitle');
        const viewDaftarSubtitle = document.getElementById('viewDaftarSubtitle');
        const viewDaftarThead = document.getElementById('viewDaftarThead');
        const detailSekolahDiv = document.getElementById('detailSekolah');
        const detailNpsnSpan = document.getElementById('detailNpsn');
        const detailStatusSpan = document.getElementById('detailStatus');
        const detailKecamatanSpan = document.getElementById('detailKecamatan');
        const detailJumlahSpan = document.getElementById('detailJumlah');
        const detailGuruDiv = document.getElementById('detailGuru');
        const searchInput = document.getElementById('searchLembaga');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const cancelBtn = document.getElementById('cancelBtn');
        const searchContainer = document.getElementById('searchContainer');
        const timeRestrictionMessage = document.getElementById('timeRestrictionMessage');
        const trialButtonsContainer = document.getElementById('trialButtonsContainer');
        const sisaWaktuContainer = document.getElementById('sisaWaktuContainer');
        const adminSudahTerdaftarInfo = document.getElementById('adminSudahTerdaftarInfo');
        const adminInfoNomorUrut = document.getElementById('adminInfoNomorUrut');
        
        // Registered Status Elements
        const statusNomorUrut = document.getElementById('statusNomorUrut');
        const statusNamaLembaga = document.getElementById('statusNamaLembaga');
        const logoutFromStatusBtn = document.getElementById('logoutFromStatusBtn');
        const viewDaftarFromStatusBtn = document.getElementById('viewDaftarFromStatusBtn');
        const statusNpsn = document.getElementById('statusNpsn');
        const statusStatus = document.getElementById('statusStatus');
        const statusKecamatan = document.getElementById('statusKecamatan');
        const statusJumlah = document.getElementById('statusJumlah');
        const statusGuru = document.getElementById('statusGuru');
        const printBtn = document.getElementById('printBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // Modals
        const exportPasswordModal = document.getElementById('exportPasswordModal');
        const exportPasswordForm = document.getElementById('exportPasswordForm');
        const cancelExport = document.getElementById('cancelExport');
        const submitExport = document.getElementById('submitExport');
        const exportPasswordInput = document.getElementById('exportPasswordInput');
        const exportPasswordError = document.getElementById('exportPasswordError');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const cancelAdminLogin = document.getElementById('cancelAdminLogin');
        const submitAdminLogin = document.getElementById('submitAdminLogin');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminLoginError = document.getElementById('adminLoginError');
        const viewDaftarActions = document.getElementById('viewDaftarActions');
        const exportBtnView = document.getElementById('exportBtnView');
        const exportBtns = document.querySelectorAll('.export-btn');
        const infoModal = document.getElementById('infoModal');
        const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
        const okInfoModalBtn = document.getElementById('okInfoModalBtn');
        const showInfoBtn = document.getElementById('showInfoBtn');
        
        // ===============================================================
        // VARIABEL STATE APLIKASI
        // ===============================================================
        let maxNumber = 0, daftarPeserta = [], masterLembagaData = [], lembagaTersedia = [];
        let selectedLembaga = null, countdownInterval = null, reliableCurrentTime = null;
        let loggedInLembaga = null;
        let isTrialModeActive = false;
        let isAdminLoggedIn = false;
        let inactivityTimer;
        
        const ICONS = {
            success: `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            warning: `<svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
            error: `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`,
            info: `<svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`
        };

        // ===============================================================
        // FUNGSI UTAMA & INTERAKSI DENGAN SERVER
        // ===============================================================

        function showCustomNotice(message, title = 'Informasi', type = 'info') {
            return new Promise(resolve => {
                customAlertTitle.textContent = title;
                customAlertMessage.innerHTML = message;
                customAlertButtons.innerHTML = '';
                let iconContainer = customAlertIcon;
                iconContainer.innerHTML = ICONS[type] || ICONS.info;
                let colorClass = { success: 'bg-green-100', warning: 'bg-yellow-100', error: 'bg-red-100', info: 'bg-blue-100', confirm: 'bg-yellow-100' }[type] || 'bg-blue-100';
                iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${colorClass} mb-4`;
                const closeModal = (value) => {
                    customAlertModal.classList.add('hidden');
                    resolve(value);
                };
                if (type === 'confirm') {
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Ya, Lanjutkan';
                    confirmBtn.className = 'w-full px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition-all';
                    confirmBtn.onclick = () => closeModal(true);
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Batal';
                    cancelBtn.className = 'w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:bg-gray-300 transition-all';
                    cancelBtn.onclick = () => closeModal(false);
                    customAlertButtons.append(cancelBtn, confirmBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'OK';
                    okBtn.className = 'w-full px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-all';
                    okBtn.onclick = () => closeModal(true);
                    customAlertButtons.append(okBtn);
                }
                customAlertModal.classList.remove('hidden');
            });
        }
        
        async function loadDataFromServer() {
            loadingOverlay.style.display = 'flex';
            try {
                const timeResponse = await fetch('https://worldtimeapi.org/api/timezone/Asia/Makassar');
                if (!timeResponse.ok) throw new Error('Gagal mengambil waktu dari server.');
                const timeData = await timeResponse.json();
                reliableCurrentTime = new Date(timeData.datetime);
            } catch (error) {
                console.warn('Gagal mengambil waktu dari worldtimeapi, menggunakan waktu lokal.', error);
                reliableCurrentTime = new Date();
            }
            try {
                // Fetch daftar peserta dan daftar lembaga (yang sudah aman/tanpa kode akses)
                const [pesertaRes, lembagaRes] = await Promise.all([
                    fetch(`${WEB_APP_URL}?action=getDaftarPeserta&t=${new Date().getTime()}`),
                    fetch(`${WEB_APP_URL}?action=getLembagaList&t=${new Date().getTime()}`)
                ]);
                if (!pesertaRes.ok) throw new Error(`Gagal mengambil daftar peserta (Status: ${pesertaRes.status})`);
                if (!lembagaRes.ok) throw new Error(`Gagal mengambil daftar lembaga (Status: ${lembagaRes.status})`);
                const pesertaData = await pesertaRes.json();
                const lembagaData = await lembagaRes.json();
                
                daftarPeserta = pesertaData.data || [];
                masterLembagaData = lembagaData.data || [];
                maxNumber = masterLembagaData.length;

                const lembagaTerdaftarNpsn = new Set(daftarPeserta.map(p => String(p.npsn)));
                lembagaTersedia = masterLembagaData.filter(l => !lembagaTerdaftarNpsn.has(String(l.npsn)));
                
                updateDaftarTampilan(reliableCurrentTime);
                renderLembagaList(lembagaTersedia);
                checkTimeRestriction(reliableCurrentTime); 
                
            } catch (error) {
                console.error('Error saat memuat data:', error);
                await showCustomNotice(`Gagal terhubung ke server. Pastikan skrip Google Anda telah di-deploy dan periksa koneksi internet Anda.<br><br><b>Detail Error:</b> ${error.message}`, 'Kesalahan Jaringan', 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        /**
         * DIUBAH TOTAL: Fungsi login kini aman, mengirim data ke server untuk validasi.
         */
        async function handleUserLogin(event) {
            event.preventDefault();
            const npsn = npsnLoginInput.value.trim();
            const kodeAkses = kodeAksesLoginInput.value.trim();

            if (!npsn || !kodeAkses) {
                loginError.textContent = "NPSN dan Kode Akses tidak boleh kosong.";
                loginError.classList.remove('hidden');
                return;
            }

            const loginButton = userLoginForm.querySelector('button[type="submit"]');
            loginButton.disabled = true;
            loginButton.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Memverifikasi...</span>
                </div>`;
            loginError.classList.add('hidden');

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'verifyUserLogin',
                        npsn: npsn,
                        kodeAkses: kodeAkses
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server Error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    // Login Berhasil
                    loggedInLembaga = result.data; // Data lembaga yang valid dari server
                    
                    const now = reliableCurrentTime;
                    const startTime = new Date(TANGGAL_MULAI);
                    isTrialModeActive = now < startTime;

                    sessionStorage.setItem('loggedInLembaga', JSON.stringify(loggedInLembaga));
                    if (isTrialModeActive) {
                        sessionStorage.setItem('isTrial', 'true');
                    }

                    const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(loggedInLembaga.npsn));
                    loginSection.classList.add('hidden');

                    if (existingRegistration && !isTrialModeActive) {
                        showRegisteredStatusPage(existingRegistration);
                    } else {
                        showMainAppFor(loggedInLembaga);
                    }
                    startInactivityTimer();

                } else {
                    // Login Gagal dari server
                    throw new Error(result.message || 'NPSN atau Kode Akses salah.');
                }

            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                // Kembalikan tombol ke keadaan semula
                loginButton.disabled = false;
                loginButton.innerHTML = 'Login';
            }
        }
        
        async function handleDeleteRegistration(npsn, namaLembaga) {
            const confirmed = await showCustomNotice(`Apakah Anda yakin ingin <b>MEMBATALKAN</b> pendaftaran untuk "${namaLembaga}"?<br><br>Aksi ini akan menghapus nomor urut mereka dan mengizinkan mereka untuk mendaftar ulang.`, 'Konfirmasi Pembatalan', 'confirm');
            if (!confirmed) return;
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deletePendaftaran', npsn: npsn })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Server gagal menghapus data.');
                
                // Refresh data dari server untuk memastikan konsistensi
                await loadDataFromServer();
                await showCustomNotice(`Pendaftaran untuk "${namaLembaga}" berhasil dibatalkan.`, 'Berhasil', 'success');

            } catch (error) {
                console.error('Gagal membatalkan pendaftaran:', error);
                await showCustomNotice(`Gagal membatalkan pendaftaran. <br><br><b>Detail Error:</b> ${error.message}`, 'Gagal', 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function handleAdminLogin() {
            const password = adminPasswordInput.value;
            if (!password) {
                adminLoginError.classList.remove('hidden');
                adminLoginError.textContent = 'Kata sandi tidak boleh kosong.';
                return;
            }
            
            submitAdminLogin.disabled = true;
            submitAdminLogin.textContent = 'Memverifikasi...';

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'adminLogin', password: password })
                });
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                const result = await response.json();

                if (result.status === 'success') {
                    isAdminLoggedIn = true;
                    isTrialModeActive = false;
                    adminLoginModal.classList.add('hidden');
                    adminPasswordInput.value = '';
                    await showCustomNotice('Login Admin berhasil!', 'Selamat Datang', 'success');
                    sessionStorage.setItem('isAdmin', 'true');
                    updateDaftarTampilan(reliableCurrentTime);
                    loginSection.classList.add('hidden');
                    mainAppSection.classList.remove('hidden');
                    adminModeBanner.classList.remove('hidden');
                    trialModeBanner.classList.add('hidden');
                    searchContainer.classList.remove('hidden');
                    detailSekolahDiv.classList.add('hidden');
                    dataForm.querySelector('button[type="submit"]').textContent = 'Ambil Nomor (Admin)';
                    startInactivityTimer();
                } else {
                    throw new Error(result.message || 'Kata sandi salah.');
                }

            } catch (error) {
                adminLoginError.textContent = error.message;
                adminLoginError.classList.remove('hidden');
            } finally {
                submitAdminLogin.disabled = false;
                submitAdminLogin.textContent = 'Login';
            }
        }

        async function exportToExcel() {
            loadingOverlay.style.display = 'flex';
            try {
                 const res = await fetch(`${WEB_APP_URL}?action=getLembagaList&t=${new Date().getTime()}`);
                 if (!res.ok) throw new Error(`Gagal mengambil data lembaga (Status: ${res.status})`);
                 const lembagaResult = await res.json();
                 const masterData = lembagaResult.data || [];

                 const pesertaRes = await fetch(`${WEB_APP_URL}?action=getDaftarPeserta&t=${new Date().getTime()}`);
                 if (!pesertaRes.ok) throw new Error(`Gagal mengambil data peserta (Status: ${pesertaRes.status})`);
                 const pesertaResult = await pesertaRes.json();
                 const dataToExport = pesertaResult.data || [];
                
                if (dataToExport.length === 0) { 
                    await showCustomNotice("Tidak ada data untuk di-export.", "Informasi", "info");
                    return; 
                };
                
                const masterDataMap = new Map(masterData.map(item => [item.npsn, item]));
                const headers = ['No. Urut', 'Nama Lembaga', 'NPSN', 'Status', 'Kecamatan', 'Jumlah Peserta', 'Guru 1', 'Jabatan 1', 'Guru 2', 'Jabatan 2', 'Guru 3', 'Jabatan 3'];
                const rows = dataToExport.sort((a,b) => a.nomor - b.nomor).map(p => {
                    const master = masterDataMap.get(p.npsn) || {};
                    return [
                        `'${String(p.nomor).padStart(3, '0')}`,
                        `"${p.nama}"`, `"${p.npsn}"`, `"${p.status}"`, `"${p.kecamatan}"`,
                        master.jumlah || '', `"${master.guru1 || ''}"`, `"${master.jabatan1 || ''}"`,
                        `"${master.guru2 || ''}"`, `"${master.jabatan2 || ''}"`, `"${master.guru3 || ''}"`, `"${master.jabatan3 || ''}"`
                    ];
                });
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `daftar_peserta_han_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                 link.click();
                document.body.removeChild(link);
            } catch(error) {
                await showCustomNotice(`Gagal mengekspor data. <br><br><b>Detail Error:</b> ${error.message}`, 'Gagal', 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function handlePendaftaran() {
            const currentLembaga = loggedInLembaga || selectedLembaga;
            
            const isStillInTrialPeriod = reliableCurrentTime < new Date(TANGGAL_MULAI);

            if (!isStillInTrialPeriod && !isAdminLoggedIn && daftarPeserta.length >= maxNumber) {
                spinBtn.classList.add('hidden');
                nomorHabisMessage.classList.remove('hidden');
                spinnerDisplay.textContent = "---";
                return;
            }

            spinBtn.disabled = true;
            spinBtn.textContent = 'Mengambil...';
            spinBtn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-teal-500');
            spinBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            
            let spinInterval = setInterval(() => {
                const randomNumber = Math.floor(Math.random() * maxNumber) + 1 || 1;
                spinnerDisplay.textContent = String(randomNumber).padStart(3, '0');
            }, SPIN_INTERVAL);

            if (isStillInTrialPeriod) {
                setTimeout(() => {
                    clearInterval(spinInterval);
                    let finalNumber;
                    const usedNumbers = new Set(daftarPeserta.map(p => p.nomor));
                    do {
                        finalNumber = Math.floor(Math.random() * maxNumber) + 1;
                    } while (usedNumbers.has(finalNumber) && usedNumbers.size < maxNumber);
                    
                    if(usedNumbers.size >= maxNumber){
                        finalNumber = 999;
                    }

                    const formattedFinalNumber = String(finalNumber).padStart(3, '0');
                    spinnerDisplay.textContent = formattedFinalNumber;
                    showResultFor({ ...currentLembaga, nomor: finalNumber }, true); 
                }, SPIN_DURATION);
                return;
            }
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'registerAndGetNumber', 
                        data: currentLembaga 
                    })
                });

                if (!response.ok) throw new Error(`Server merespon dengan status: ${response.status}`);
                
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Terjadi kesalahan di server.');
                
                clearInterval(spinInterval);
                
                const finalNumber = result.assignedNumber;
                const formattedFinalNumber = String(finalNumber).padStart(3, '0');
                spinnerDisplay.textContent = formattedFinalNumber;

                // Refresh data dari server setelah berhasil mendaftar
                await loadDataFromServer();
                
                const dataYangDisimpan = { ...currentLembaga, nomor: finalNumber };
                showResultFor(dataYangDisimpan, false);

            } catch (err) {
                clearInterval(spinInterval);
                console.error('Error saat mendaftar:', err);
                await showCustomNotice(`Gagal mendapatkan nomor urut. <br><br><b>Pesan:</b> ${err.message}`, 'Gagal', 'error');
                
                spinBtn.disabled = false;
                spinBtn.textContent = 'Ambil Nomor!';
                spinBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-teal-500');
                spinBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }
        
        // ===============================================================
        // FUNGSI PENGATUR TAMPILAN (UI/UX)
        // ===============================================================

        function updateTimer(targetDate, element, onEnd, prefix, suffix, now) {
            const distance = targetDate - now;
            if (distance < 0) {
                clearInterval(countdownInterval);
                onEnd();
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            element.innerHTML = `
                <p class="mb-2 font-semibold">${prefix}</p>
                <div>
                    ${days > 0 ? `<div class="timer-box"><span>${String(days).padStart(2, '0')}</span><span>Hari</span></div>` : ''}
                    <div class="timer-box"><span>${String(hours).padStart(2, '0')}</span><span>Jam</span></div>
                    <div class="timer-box"><span>${String(minutes).padStart(2, '0')}</span><span>Menit</span></div>
                    <div class="timer-box"><span>${String(seconds).padStart(2, '0')}</span><span>Detik</span></div>
                </div>
                ${suffix ? `<p class="mt-2 text-sm text-gray-500">${suffix}</p>` : ''}
            `;
        }

        function checkTimeRestriction(currentTime) {
            const targetContainer = loggedInLembaga ? sisaWaktuContainer : timeRestrictionMessage;
            
            if (isAdminLoggedIn) {
                timeRestrictionMessage.classList.add('hidden');
                sisaWaktuContainer.classList.add('hidden');
                trialButtonsContainer.classList.add('hidden');
                return true; 
            }
            
            clearInterval(countdownInterval); 
            const now = currentTime;
            const startTime = new Date(TANGGAL_MULAI);
            const endTime = new Date(TANGGAL_SELESAI);
            const onTimerEnd = () => location.reload();

            if (now < startTime) {
                targetContainer.classList.remove('hidden');
                targetContainer.className = 'text-center font-semibold p-4 rounded-lg my-4 bg-yellow-100 text-yellow-800';
                
                updateTimer(startTime, targetContainer, onTimerEnd, "Pendaftaran akan dibuka dalam:", null, now.getTime());
                countdownInterval = setInterval(() => {
                    now.setSeconds(now.getSeconds() + 1); 
                    updateTimer(startTime, targetContainer, onTimerEnd, "Pendaftaran akan dibuka dalam:", null, now.getTime());
                }, 1000);
                
                if(!loggedInLembaga) {
                    userLoginForm.classList.add('hidden');
                    trialButtonsContainer.classList.remove('hidden');
                    trialButtonsContainer.innerHTML = `
                        <button type="button" id="viewDaftarBeforeStartBtn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-gray-50 transform transition-all border-2 border-gray-200 shadow-sm flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                            Lihat Daftar Lembaga
                        </button>
                        <button type="button" id="startTrialLoginBtn" class="w-full bg-purple-50 text-purple-700 font-semibold py-3 px-4 rounded-xl hover:shadow-lg hover:bg-purple-100 transform transition-all border-2 border-purple-200 shadow-sm flex items-center justify-center gap-2 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                            Uji Coba Aplikasi
                        </button>
                    `;
                    document.getElementById('viewDaftarBeforeStartBtn').addEventListener('click', () => {
                        loginSection.classList.add('hidden');
                        viewDaftarSection.classList.remove('hidden');
                    });
                    document.getElementById('startTrialLoginBtn').addEventListener('click', () => {
                        trialButtonsContainer.classList.add('hidden');
                        userLoginForm.classList.remove('hidden');
                        npsnLoginInput.focus();
                    });
                }
                return false;
            } else if (now > endTime) {
                targetContainer.innerHTML = `Waktu pengambilan nomor sudah berakhir.`;
                targetContainer.className = 'text-center font-semibold p-4 rounded-lg my-4 bg-red-100 text-red-800';
                targetContainer.classList.remove('hidden');
                trialButtonsContainer.classList.add('hidden');
                userLoginForm.classList.add('hidden');
                return false;
            } else {
                 if (loggedInLembaga) { 
                    timeRestrictionMessage.classList.add('hidden');
                    sisaWaktuContainer.classList.remove('hidden');
                    sisaWaktuContainer.className = 'text-center p-3 rounded-lg my-4 bg-blue-100 text-blue-800';
                    updateTimer(endTime, sisaWaktuContainer, onTimerEnd, "Sisa waktu pendaftaran:", null, now.getTime());
                    countdownInterval = setInterval(() => {
                        now.setSeconds(now.getSeconds() + 1);
                        updateTimer(endTime, sisaWaktuContainer, onTimerEnd, "Sisa waktu pendaftaran:", null, now.getTime());
                    }, 1000);
                 } else { 
                    timeRestrictionMessage.classList.add('hidden');
                    sisaWaktuContainer.classList.add('hidden');
                 }
                trialButtonsContainer.classList.add('hidden');
                userLoginForm.classList.remove('hidden');
                return true;
            }
        }
        
        function updateDaftarTampilan(now) {
            const startTime = new Date(TANGGAL_MULAI);
            const isBeforeStart = now < startTime;
            daftarPeserta.sort((a, b) => a.nomor - b.nomor);
            let rowsHtmlResult = daftarPeserta.length === 0 ? '<tr><td colspan="3" class="p-4 text-center text-gray-500">Belum ada peserta terdaftar.</td></tr>' : daftarPeserta.map(p => `<tr class="hover:bg-yellow-50 even:bg-blue-50/50"><td class="p-3 text-center font-bold text-blue-600">${String(p.nomor).padStart(3, '0')}</td><td class="p-3 text-left">${p.nama}</td><td class="p-3 text-left">${p.kecamatan}</td></tr>`).join('');
            daftarBodyResult.innerHTML = rowsHtmlResult;
            let rowsHtmlView = '';
            if (isBeforeStart && !isTrialModeActive && !isAdminLoggedIn) {
                viewDaftarTitle.textContent = 'Daftar Lembaga';
                viewDaftarSubtitle.textContent = 'Hanya lembaga yang terdaftar di sistem yang bisa mengambil nomor urut.';
                viewDaftarThead.innerHTML = `<tr><th class="p-3 font-semibold text-gray-600 text-left">Nama Lembaga</th><th class="p-3 font-semibold text-gray-600 text-left">NPSN</th><th class="p-3 font-semibold text-gray-600 text-left">Kecamatan</th></tr>`;
                exportBtnView.classList.add('hidden');
                viewDaftarActions.classList.remove('grid-cols-2');
                viewDaftarActions.classList.add('grid-cols-1');
                const sortedLembaga = [...masterLembagaData].sort((a,b) => a.nama.localeCompare(b.nama));
                rowsHtmlView = sortedLembaga.length === 0 ? '<tr><td colspan="3" class="p-4 text-center text-gray-500">Belum ada data lembaga.</td></tr>' : sortedLembaga.map(l => `<tr class="hover:bg-yellow-50"><td class="p-3 text-left break-words">${l.nama}</td><td class="p-3 text-left">${l.npsn}</td><td class="p-3 text-left">${l.kecamatan}</td></tr>`).join('');
            } else {
                viewDaftarTitle.textContent = 'Daftar Peserta';
                viewDaftarSubtitle.textContent = 'Rekapitulasi lembaga yang sudah mengambil Nomor Peserta Karnaval';
                viewDaftarThead.innerHTML = `<tr><th class="p-3 font-semibold text-gray-600">No. Urut</th><th class="p-3 font-semibold text-gray-600 text-left">Nama Lembaga</th><th class="p-3 font-semibold text-gray-600 text-left">NPSN</th><th class="p-3 font-semibold text-gray-600 text-left">Kecamatan</th>${isAdminLoggedIn ? '<th class="p-3 font-semibold text-gray-600 text-center">Aksi</th>' : ''}</tr>`;
                exportBtnView.classList.remove('hidden');
                viewDaftarActions.classList.add('grid-cols-2');
                viewDaftarActions.classList.remove('grid-cols-1');
                rowsHtmlView = daftarPeserta.length === 0 ? `<tr><td colspan="${isAdminLoggedIn ? 5 : 4}" class="p-4 text-center text-gray-500">Belum ada peserta terdaftar.</td></tr>` : daftarPeserta.map(l => `<tr class="hover:bg-yellow-50"><td class="p-3 text-center font-bold text-blue-600">${String(l.nomor).padStart(3, '0')}</td><td class="p-3 text-left break-words">${l.nama}</td><td class="p-3 text-left">${l.npsn}</td><td class="p-3 text-left">${l.kecamatan}</td>${isAdminLoggedIn ? `<td class="p-3 text-center"><button class="text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded-md bg-red-100 hover:bg-red-200 transition-all" data-npsn="${l.npsn}" data-nama="${l.nama}">Batalkan</button></td>` : ''}</tr>`).join('');
            }
            daftarBodyView.innerHTML = rowsHtmlView;
            if (isAdminLoggedIn) {
                document.querySelectorAll('#daftarBodyView button[data-npsn]').forEach(button => button.addEventListener('click', (e) => handleDeleteRegistration(e.target.dataset.npsn, e.target.dataset.nama)));
            }
            exportBtns.forEach(btn => btn.disabled = (daftarPeserta.length === 0));
        }
        
        function renderLembagaList(items) {
            dropdownMenu.innerHTML = '';
            if (items.length === 0) {
                const div = document.createElement('div');
                div.textContent = 'Semua lembaga sudah terdaftar atau tidak ada hasil';
                div.className = 'p-3 text-center text-gray-500';
                dropdownMenu.appendChild(div);
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item.nama;
                div.className = 'p-3 hover:bg-blue-100 cursor-pointer transition-colors duration-150 rounded-lg';
                div.addEventListener('click', () => {
                    searchInput.value = item.nama;
                    selectedLembaga = item;
                    if (isAdminLoggedIn) {
                        checkAdminLembagaSelection(item);
                    }
                    showLembagaDetails(item);
                    detailSekolahDiv.classList.remove('hidden');
                    dropdownMenu.classList.add('hidden');
                });
                dropdownMenu.appendChild(div);
            });
        }
        
        function checkAdminLembagaSelection(lembaga) {
            const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(lembaga.npsn));
            const submitBtn = dataForm.querySelector('button[type="submit"]');

            if (existingRegistration) {
                adminInfoNomorUrut.textContent = String(existingRegistration.nomor).padStart(3, '0');
                adminSudahTerdaftarInfo.classList.remove('hidden');
                submitBtn.classList.add('hidden'); 
            } else {
                adminSudahTerdaftarInfo.classList.add('hidden');
                submitBtn.classList.remove('hidden'); 
            }
        }


        function showLembagaDetails(lembaga) {
             welcomeMessage.innerHTML = `Selamat Datang :<br><span class="text-2xl font-fredoka">${lembaga.nama}</span>`;
             detailNpsnSpan.textContent = `: ${lembaga.npsn}`;
             detailStatusSpan.textContent = `: ${lembaga.status}`;
             detailKecamatanSpan.textContent = `: ${lembaga.kecamatan}`;
             detailJumlahSpan.textContent = `: ${lembaga.jumlah} orang`;
             detailGuruDiv.innerHTML = `<p>1. ${lembaga.guru1} (${lembaga.jabatan1})</p><p>2. ${lembaga.guru2} (${lembaga.jabatan2})</p><p>3. ${lembaga.guru3} (${lembaga.jabatan3})</p>`;
             detailSekolahDiv.classList.remove('hidden');
        }

        function showMainAppFor(lembaga) {
            searchContainer.classList.add('hidden'); 
            showLembagaDetails(lembaga);
            mainAppSection.classList.remove('hidden');
            
            if (isTrialModeActive) {
                trialModeBanner.classList.remove('hidden');
            } else {
                trialModeBanner.classList.add('hidden');
            }

            const submitBtn = dataForm.querySelector('button[type="submit"]');
            const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(lembaga.npsn));
            
            if (existingRegistration && !isAdminLoggedIn && !isTrialModeActive) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Anda Sudah Terdaftar';
                submitBtn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-yellow-500');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = isTrialModeActive ? 'Ambil Nomor (Uji Coba)' : 'Ambil Nomor';
                submitBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-yellow-500');
                submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
            
            checkTimeRestriction(reliableCurrentTime);
        }
        
        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return;
            container.innerHTML = '';
            const colors = ['#fde68a', '#fca5a5', '#818cf8', '#6ee7b7', '#a78bfa'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);
            }
        }
        
        function triggerSparkles(container) {
            if (!container) return;
            const sparkleContainer = container.querySelector('.sparkle-container');
            if (!sparkleContainer) return;
            sparkleContainer.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.top = `${Math.random() * 100}%`;
                sparkle.style.left = `${Math.random() * 100}%`;
                sparkle.style.animationDelay = `${Math.random() * 0.5}s`;
                sparkleContainer.appendChild(sparkle);
            }
        }

        function showResultFor(registrationData, isTrial = false) {
            if (isTrial) {
                 resultNamaLembaga.innerHTML = `${registrationData.nama} <span class="text-purple-600 font-bold">(UJI COBA)</span>`;
            } else {
                resultNamaLembaga.textContent = registrationData.nama;
            }
            nomorUrutDisplay.textContent = String(registrationData.nomor).padStart(3, '0');
            
            mainAppSection.classList.add('hidden');
            spinnerSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            triggerConfetti();
        }

        function showRegisteredStatusPage(registrationData) {
            loginSection.classList.add('hidden');
            mainAppSection.classList.add('hidden');
            spinnerSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            viewDaftarSection.classList.add('hidden');

            const fullLembagaData = masterLembagaData.find(l => String(l.npsn) === String(registrationData.npsn));
            if (!fullLembagaData) {
                console.error("Data master tidak ditemukan untuk NPSN:", registrationData.npsn);
                statusNamaLembaga.textContent = registrationData.nama;
                statusNpsn.textContent = `: ${registrationData.npsn}`;
                statusKecamatan.textContent = `: ${registrationData.kecamatan}`;
                statusStatus.textContent = ": -";
                statusJumlah.textContent = ": -";
                statusGuru.innerHTML = "Tidak ada data.";
            } else {
                statusNamaLembaga.textContent = fullLembagaData.nama;
                statusNpsn.textContent = `: ${fullLembagaData.npsn}`;
                statusStatus.textContent = `: ${fullLembagaData.status}`;
                statusKecamatan.textContent = `: ${fullLembagaData.kecamatan}`;
                statusJumlah.textContent = `: ${fullLembagaData.jumlah} orang`;
                statusGuru.innerHTML = `<p>1. ${fullLembagaData.guru1} (${fullLembagaData.jabatan1})</p>
                                        <p>2. ${fullLembagaData.guru2} (${fullLembagaData.jabatan2})</p>
                                        <p>3. ${fullLembagaData.guru3} (${fullLembagaData.jabatan3})</p>`;
            }

            statusNomorUrut.textContent = String(registrationData.nomor).padStart(3, '0');
            
            registeredStatusSection.classList.remove('hidden');
            triggerSparkles(registeredStatusSection);
        }

        function handleLogout(isAutoLogout = false) {
            clearTimeout(inactivityTimer);
            window.removeEventListener('mousemove', resetInactivityTimer);
            window.removeEventListener('mousedown', resetInactivityTimer);
            window.removeEventListener('keypress', resetInactivityTimer);
            window.removeEventListener('touchstart', resetInactivityTimer);

            sessionStorage.clear();
            loggedInLembaga = null;
            isAdminLoggedIn = false;
            isTrialModeActive = false;
            selectedLembaga = null;
            
            if(reliableCurrentTime) {
                updateDaftarTampilan(reliableCurrentTime);
            }

            mainAppSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            viewDaftarSection.classList.add('hidden');
            spinnerSection.classList.add('hidden');
            adminModeBanner.classList.add('hidden');
            trialModeBanner.classList.add('hidden');
            registeredStatusSection.classList.add('hidden');
            adminSudahTerdaftarInfo.classList.add('hidden');
            dataForm.querySelector('button[type="submit"]').classList.remove('hidden');

            userLoginForm.reset();
            loginError.classList.add('hidden');
            loginSection.classList.remove('hidden');
            checkTimeRestriction(reliableCurrentTime);
            if (isAutoLogout) {
                showCustomNotice('Anda telah logout secara otomatis karena tidak ada aktivitas selama 5 menit.', 'Sesi Berakhir', 'info');
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => handleLogout(true), INACTIVITY_TIMEOUT);
        }

        function startInactivityTimer() {
            resetInactivityTimer();
            window.addEventListener('mousemove', resetInactivityTimer);
            window.addEventListener('mousedown', resetInactivityTimer);
            window.addEventListener('keypress', resetInactivityTimer);
            window.addEventListener('touchstart', resetInactivityTimer);
        }
        
        function getPrintableContent(registrationData, fullLembagaData) {
            const documentDate = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
            return `
                <div style="font-family: 'Inter', sans-serif; width: 210mm; height: 297mm; padding: 20mm; display: flex; flex-direction: column; background-color: white; box-sizing: border-box;">
                    <header style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQq9BqgIl6ON8ljjfpIV1tbRhV2cA_K_iYzcg&s" style="height: 80px;" alt="Logo Tut Wuri Handayani" crossorigin="anonymous">
                        <div>
                            <h1 style="font-size: 24px; font-weight: 700; color: #1e3a8a; margin: 0;">Bukti Pendaftaran</h1>
                            <p style="font-size: 18px; font-weight: 600; color: #374151; margin: 4px 0 0;">Karnaval Hari Anak Nasional 2025</p>
                        </div>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Lambang_Kabupaten_Tabalong.jpeg/500px-Lambang_Kabupaten_Tabalong.jpeg" style="height: 90px;" alt="Logo Tabalong" crossorigin="anonymous">
                    </header>
                    
                    <main style="flex-grow: 1;">
                        <div style="text-align: center; margin-bottom: 32px;">
                            <p style="font-size: 16px; color: #4b5563; margin:0;">Nomor Urut Peserta:</p>
                            <p style="font-family: 'Fredoka One', cursive; font-size: 120px; color: #2563eb; margin: 8px 0; line-height: 1;">
                                ${String(registrationData.nomor).padStart(3, '0')}
                            </p>
                        </div>

                        <div style="background-color: #eff6ff; border-radius: 12px; padding: 24px; border: 1px solid #bfdbfe;">
                            <h2 style="font-size: 28px; font-weight: 700; color: #1e3a8a; text-align: center; margin-top: 0; margin-bottom: 24px;">
                                ${fullLembagaData.nama}
                            </h2>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <tbody style="color: #374151;">
                                    <tr><td style="padding: 8px; font-weight: 600; width: 30%;">NPSN</td><td style="padding: 8px;">: ${fullLembagaData.npsn}</td></tr>
                                    <tr style="background-color: #f9fafb;"><td style="padding: 8px; font-weight: 600;">Status</td><td style="padding: 8px;">: ${fullLembagaData.status}</td></tr>
                                    <tr><td style="padding: 8px; font-weight: 600;">Kecamatan</td><td style="padding: 8px;">: ${fullLembagaData.kecamatan}</td></tr>
                                    <tr style="background-color: #f9fafb;"><td style="padding: 8px; font-weight: 600;">Jumlah Peserta</td><td style="padding: 8px;">: ${fullLembagaData.jumlah} orang</td></tr>
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; vertical-align: top;">Guru Perwakilan</td>
                                        <td style="padding: 8px; line-height: 1.6;">
                                            : 1. ${fullLembagaData.guru1} (${fullLembagaData.jabatan1})<br>
                                            &nbsp;&nbsp;2. ${fullLembagaData.guru2} (${fullLembagaData.jabatan2})<br>
                                            &nbsp;&nbsp;3. ${fullLembagaData.guru3} (${fullLembagaData.jabatan3})
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </main>

                    <footer style="text-align: center; margin-top: auto; padding-top: 24px;">
                         <p style="font-size: 14px; font-weight: 600; color: #374151;">Dinas Pendidikan & Kebudayaan Kabupaten Tabalong</p>
                         <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Dokumen ini dibuat secara otomatis oleh sistem pada: ${documentDate}</p>
                    </footer>
                </div>
            `;
        }
        
        async function handleDownload() {
            const currentLembaga = loggedInLembaga;
            if (!currentLembaga) return;

            const registrationData = daftarPeserta.find(p => String(p.npsn) === String(currentLembaga.npsn));
            const fullLembagaData = masterLembagaData.find(l => String(l.npsn) === String(currentLembaga.npsn));

            if (!registrationData || !fullLembagaData) {
                showCustomNotice('Data pendaftaran tidak lengkap untuk diunduh.', 'Error', 'error');
                return;
            }
            
            loadingOverlay.style.display = 'flex';
            loadingOverlay.querySelector('p').textContent = 'Membuat file PDF...';

            const printContent = getPrintableContent(registrationData, fullLembagaData);
            
            const element = document.createElement('div');
            element.innerHTML = printContent;
            element.style.position = 'absolute';
            element.style.left = '-9999px'; 
            document.body.appendChild(element);

            const opt = {
              margin:       0,
              filename:     `Bukti_Pendaftaran_HAN_2025_${fullLembagaData.nama.replace(/[^a-z0-9]/gi, '_')}.pdf`,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2, useCORS: true },
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(element.firstElementChild).save();
            } catch (error) {
                console.error("Gagal membuat PDF:", error);
                await showCustomNotice('Terjadi kesalahan saat membuat file PDF.', 'Error', 'error');
            } finally {
                document.body.removeChild(element);
                loadingOverlay.style.display = 'none';
                loadingOverlay.querySelector('p').textContent = 'Memuat data dari server...';
            }
        }

        function handlePrint() {
            const currentLembaga = loggedInLembaga;
            if (!currentLembaga) return;

            const registrationData = daftarPeserta.find(p => String(p.npsn) === String(currentLembaga.npsn));
            const fullLembagaData = masterLembagaData.find(l => String(l.npsn) === String(currentLembaga.npsn));

            if (!registrationData || !fullLembagaData) {
                showCustomNotice('Data pendaftaran tidak lengkap untuk dicetak.', 'Error', 'error');
                return;
            }
            
            const printContent = getPrintableContent(registrationData, fullLembagaData);
            
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            printContainer.innerHTML = printContent;
            document.body.appendChild(printContainer);
            
            setTimeout(() => {
                window.print();
                document.body.removeChild(printContainer);
            }, 100);
        }

        async function handleExport() {
            const password = exportPasswordInput.value;
            if (!password) {
                exportPasswordError.textContent = "Kata sandi tidak boleh kosong.";
                exportPasswordError.classList.remove('hidden');
                return;
            }

            submitExport.disabled = true;
            submitExport.textContent = 'Memeriksa...';
            exportPasswordError.classList.add('hidden');

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'verifyPassword', password: password })
                });
                if (!response.ok) throw new Error('Gagal terhubung ke server.');
                const result = await response.json();

                if (result.status === 'success') {
                    exportPasswordModal.classList.add('hidden');
                    exportPasswordInput.value = '';
                    exportToExcel(); 
                } else {
                    throw new Error(result.message || 'Kata sandi salah.');
                }
            } catch (error) {
                exportPasswordError.textContent = error.message;
                exportPasswordError.classList.remove('hidden');
            } finally {
                submitExport.disabled = false;
                submitExport.textContent = 'Export';
            }
        }
        
        // ===============================================================
        // EVENT LISTENERS
        // ===============================================================

        userLoginForm.addEventListener('submit', handleUserLogin);
        logoutBtn.addEventListener('click', () => handleLogout(false));
        logoutFromStatusBtn.addEventListener('click', () => handleLogout(false));
        spinBtn.addEventListener('click', handlePendaftaran);
        
        dataForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const currentLembaga = loggedInLembaga || selectedLembaga;
            if (isAdminLoggedIn && !currentLembaga) {
                errorMessage.classList.remove('hidden');
                return;
            }
            
            if (!reliableCurrentTime) {
                await showCustomNotice("Waktu belum tersinkronisasi. Mohon muat ulang halaman.", "Peringatan", "warning");
                return;
            }

            const now = reliableCurrentTime;
            const startTime = new Date(TANGGAL_MULAI);
            const endTime = new Date(TANGGAL_SELESAI);
            
            if (!isAdminLoggedIn && (now < startTime || now > endTime)) {
                checkTimeRestriction(now);
                return;
            }
            errorMessage.classList.add('hidden');
            
            displayNamaLembaga.textContent = currentLembaga.nama;
            mainAppSection.classList.add('hidden');
            spinnerSection.classList.remove('hidden');
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            // Admin mencari di semua data, pengguna biasa mencari di yg tersedia
            const sourceData = isAdminLoggedIn ? masterLembagaData : lembagaTersedia;
            const filtered = sourceData.filter(l => l.nama.toLowerCase().includes(query));
            renderLembagaList(filtered);
            selectedLembaga = null;
            detailSekolahDiv.classList.add('hidden');
            dropdownMenu.classList.remove('hidden');
            adminSudahTerdaftarInfo.classList.add('hidden');
            dataForm.querySelector('button[type="submit"]').classList.remove('hidden');
        });

        searchInput.addEventListener('focus', () => {
            const sourceData = isAdminLoggedIn ? masterLembagaData : lembagaTersedia;
            renderLembagaList(sourceData);
            dropdownMenu.classList.remove('hidden');
        });
        
        document.addEventListener('click', (e) => {
            if (!searchContainer.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        cancelBtn.addEventListener('click', function() {
            spinnerSection.classList.add('hidden');
            mainAppSection.classList.remove('hidden');
            spinBtn.disabled = false;
            spinBtn.textContent = 'Ambil Nomor!';
            spinBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-teal-500');
            spinBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        });
        
        kembaliBtn.addEventListener('click', () => {
            viewDaftarSection.classList.add('hidden');
            
            if (isAdminLoggedIn || isTrialModeActive) {
                mainAppSection.classList.remove('hidden');
                return;
            }

            if (loggedInLembaga) {
                const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(loggedInLembaga.npsn));
                if (existingRegistration) {
                    showRegisteredStatusPage(existingRegistration);
                } else {
                    mainAppSection.classList.remove('hidden');
                }
            } else {
                loginSection.classList.remove('hidden');
            }
        });

        exportPasswordForm.addEventListener('submit', (e) => { e.preventDefault(); handleExport(); });
        submitExport.addEventListener('click', handleExport);
        cancelExport.addEventListener('click', () => {
            exportPasswordModal.classList.add('hidden');
            exportPasswordError.classList.add('hidden');
            exportPasswordInput.value = '';
        });

        exportBtns.forEach(btn => btn.addEventListener('click', () => {
             exportPasswordModal.classList.remove('hidden');
             exportPasswordInput.focus();
        }));

        adminLoginForm.addEventListener('submit', (e) => { e.preventDefault(); handleAdminLogin(); });
        submitAdminLogin.addEventListener('click', handleAdminLogin);
        cancelAdminLogin.addEventListener('click', () => {
            adminLoginModal.classList.add('hidden');
            adminLoginError.classList.add('hidden');
            adminPasswordInput.value = '';
        });
        
        adminLoginBtn.addEventListener('click', () => {
            adminPasswordInput.value = '';
            adminLoginError.classList.add('hidden');
            adminLoginModal.classList.remove('hidden');
            adminPasswordInput.focus();
        });

        viewDaftarBtn.addEventListener('click', () => {
            mainAppSection.classList.add('hidden');
            viewDaftarSection.classList.remove('hidden');
        });
        
        viewDaftarFromStatusBtn.addEventListener('click', () => {
            registeredStatusSection.classList.add('hidden');
            viewDaftarSection.classList.remove('hidden');
        });

        kembaliKeUtamaBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            spinBtn.disabled = false;
            spinBtn.textContent = 'Ambil Nomor!';
            spinBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-teal-500');
            spinBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');

            if (isAdminLoggedIn || isTrialModeActive) {
                mainAppSection.classList.remove('hidden');
                if(isAdminLoggedIn) {
                    searchInput.value = '';
                    selectedLembaga = null;
                    detailSekolahDiv.classList.add('hidden');
                    adminSudahTerdaftarInfo.classList.add('hidden');
                    dataForm.querySelector('button[type="submit"]').classList.remove('hidden');
                }
            } else {
                const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(loggedInLembaga?.npsn));
                if (existingRegistration) {
                    showRegisteredStatusPage(existingRegistration);
                } else {
                    showMainAppFor(loggedInLembaga); 
                }
            }
        });

        printBtn.addEventListener('click', handlePrint);
        downloadBtn.addEventListener('click', handleDownload);

        const showInfoModal = () => infoModal.classList.remove('hidden');
        const hideInfoModal = () => infoModal.classList.add('hidden');

        showInfoBtn.addEventListener('click', showInfoModal);
        closeInfoModalBtn.addEventListener('click', hideInfoModal);
        okInfoModalBtn.addEventListener('click', hideInfoModal);

        // ===============================================================
        // INISIALISASI APLIKASI
        // ===============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataFromServer();
            
            const savedLembaga = sessionStorage.getItem('loggedInLembaga');
            const savedAdmin = sessionStorage.getItem('isAdmin');
            const savedTrial = sessionStorage.getItem('isTrial');

            if (savedLembaga) {
                loggedInLembaga = JSON.parse(savedLembaga);
                isTrialModeActive = savedTrial === 'true';
                
                const existingRegistration = daftarPeserta.find(p => String(p.npsn) === String(loggedInLembaga.npsn));
                loginSection.classList.add('hidden');
                
                if (existingRegistration && !isTrialModeActive) {
                    showRegisteredStatusPage(existingRegistration);
                } else {
                    showMainAppFor(loggedInLembaga);
                }
                startInactivityTimer();

            } else if (savedAdmin) {
                isAdminLoggedIn = true;
                isTrialModeActive = false;
                updateDaftarTampilan(reliableCurrentTime);
                loginSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                adminModeBanner.classList.remove('hidden');
                searchContainer.classList.remove('hidden');
                detailSekolahDiv.classList.add('hidden');
                dataForm.querySelector('button[type="submit"]').textContent = 'Ambil Nomor (Admin)';
                startInactivityTimer();
            } else {
                loginSection.classList.remove('hidden');
            }
        });

    </script>

</body>
</html>
